<div [formGroup]="patientForm" class="patient-form-container">
  <div [attr.fxLayout]="layout" [attr.fxLayoutGap]="layout === 'row' ? '10px' : '0'"
    [attr.fxLayoutAlign]="layout === 'row' ? 'start center' : 'start'" [attr.fxLayoutAlign.xs]="'center center'"
    class="patient-container">

    <!-- DNI paciente -->
    <mat-form-field [appearance]="appearance" fxFlex="50">
      <mat-label>DNI paciente</mat-label>
      <input type="text" tabIndex="1" #dni placeholder="DNI" aria-label="Number" matInput required maxlength="8"
        formControlName="dni" [matAutocomplete]="auto">

      <mat-spinner matSuffix [color]="spinnerColor" [diameter]="20" *ngIf="dniShowSpinner"></mat-spinner>

      <mat-autocomplete #auto="matAutocomplete">
        <mat-option *ngFor="let patient of patientSearch" (onSelectionChange)="completePatientInputs(patient)"
          [value]="patient.dni">
          {{patient.lastName}} {{patient | patientName}} DNI {{patient.dni}}
        </mat-option>
      </mat-autocomplete>

      <mat-hint align="end">{{dni.value.length}} / 8</mat-hint>

      <mat-error *ngIf="patientDni.errors?.['required']">
        Debe ingresar el DNI del paciente
      </mat-error>

      <mat-error *ngIf="patientDni.errors?.['minlength'] && patientDni.touched">
        El DNI debe tener al menos {{patientDni.errors?.['minlength'].requiredLength}} dígitos
      </mat-error>

      <mat-error *ngIf="patientDni.errors?.['pattern'] && patientDni.touched">
        El DNI debe contener solo números
      </mat-error>
    </mat-form-field>

    <!-- Sexo paciente -->
    <mat-form-field [appearance]="appearance" fxFlex="50">
      <mat-label>Sexo</mat-label>
      <mat-select formControlName="sex" required tabIndex="2">
        <mat-option *ngFor="let sex of sex_options" [value]="sex">
          {{ sex }}
        </mat-option>
      </mat-select>

      <mat-error *ngIf="patientSex.errors?.['required'] && patientSex.touched">
        Debe seleccionar el sexo del paciente
      </mat-error>
    </mat-form-field>
  </div>

  <!-- Segunda fila: Apellido y Nombre -->
  <div [attr.fxLayout]="layout" [attr.fxLayoutGap]="layout === 'row' ? '10px' : '0'"
    [attr.fxLayoutAlign]="layout === 'row' ? 'start center' : 'start'" [attr.fxLayoutAlign.xs]="'center center'"
    class="patient-container">

    <!-- Apellido paciente -->
    <mat-form-field [appearance]="appearance" fxFlex="100">
      <mat-label>Apellido paciente</mat-label>
      <input type="text" tabIndex="3" placeholder="Apellido" matInput required formControlName="lastName">

      <mat-error *ngIf="patientLastName.errors?.['required'] && patientLastName.touched">
        Debe ingresar el apellido del paciente
      </mat-error>
    </mat-form-field>

    <!-- Nombre paciente -->
    <mat-form-field [appearance]="appearance" fxFlex="100">
      <mat-label>Nombre paciente</mat-label>
      <input type="text" tabIndex="4" placeholder="Nombre" matInput required formControlName="firstName"
        [value]="displayPatientName">

      <mat-error *ngIf="patientFirstName.errors?.['required'] && patientFirstName.touched">
        Debe ingresar el nombre del paciente
      </mat-error>
    </mat-form-field>

    <!-- Nombre autopercibido -->
    <mat-form-field [appearance]="appearance" fxFlex="100">
      <mat-label>Nombre autopercibido</mat-label>
      <input type="text" tabIndex="5" placeholder="Nombre autopercibido" matInput formControlName="nombreAutopercibido">
    </mat-form-field>


  </div>

  <!-- Segunda fila: Apellido y Nombre -->
  <div [attr.fxLayout]="layout" [attr.fxLayoutGap]="layout === 'row' ? '10px' : '0'"
    [attr.fxLayoutAlign]="layout === 'row' ? 'start center' : 'start'" [attr.fxLayoutAlign.xs]="'center center'"
    class="patient-container">

    <!-- Fecha de nacimiento -->
    <mat-form-field appearance="fill" fxFlex="50" fxFlex.xs="100" *ngIf="showFechaNac">
      <mat-label>Fecha de nacimiento</mat-label>
      <input matInput [matDatepicker]="fechaNacPicker" formControlName="fechaNac" placeholder="DD/MM/AAAA" required
        tabIndex="6" readonly [min]="minDate" [max]="maxDate">
      <mat-datepicker-toggle matSuffix [for]="fechaNacPicker"></mat-datepicker-toggle>
      <mat-datepicker #fechaNacPicker [startAt]="null" [touchUi]="false" [startView]="'multi-year'"></mat-datepicker>

      <mat-error *ngIf="patientFechaNac.errors?.required">
        Debe ingresar la fecha de nacimiento
      </mat-error>
      <mat-error *ngIf="patientFechaNac.errors?.invalidDate">
        Fecha inválida
      </mat-error>
      <mat-error *ngIf="patientFechaNac.errors?.futureDate">
        La fecha de nacimiento no puede ser futura
      </mat-error>
      <mat-error *ngIf="patientFechaNac.errors?.tooOldDate">
        La fecha de nacimiento debe ser posterior a 1900
      </mat-error>
    </mat-form-field>
  </div>

  <!-- Sección de Obra Social (opcional) -->
  <div *ngIf="showObraSocial" class="obra-social-section">
    <mat-checkbox formControlName="otraOS">Elegir otra cobertura social</mat-checkbox>

    <div formGroupName="os" [attr.fxLayout]="layout" [attr.fxLayoutGap]="layout === 'row' ? '10px' : '0'"
      [attr.fxLayoutAlign]="layout === 'row' ? 'start center' : 'start'" [attr.fxLayoutAlign.xs]="'center center'"
      class="obra-social-container">

      <!-- Obra Social - Select cuando hay paciente y checkbox no marcado -->
      <mat-form-field appearance="fill" fxFlex="100" *ngIf="!patientForm.get('otraOS')?.value">
        <mat-label>Obra Social</mat-label>
        <mat-select formControlName="nombre" (selectionChange)="onOsSelected($event.value)">
          <mat-option *ngIf="!obraSocial || obraSocial.length === 0" disabled>
            Sin obras sociales del paciente
          </mat-option>
          <mat-option *ngFor="let os of obraSocial" [value]="os.nombre">
            {{ os.nombre }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Obra Social - Autocomplete cuando checkbox está marcado -->
      <mat-form-field appearance="fill" fxFlex="100" *ngIf="patientForm.get('otraOS')?.value">
        <mat-label>Obra Social</mat-label>
        <input type="text" matInput formControlName="nombre" [matAutocomplete]="autoOS"
          placeholder="Buscar obra social">

        <mat-autocomplete #autoOS="matAutocomplete" [displayWith]="displayOs"
          (optionSelected)="onOsSelected($event.option.value)">
          <mat-option *ngFor="let os of filteredObrasSociales | async" [value]="os">

            {{ os.nombre }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <!-- Número de Afiliado -->
      <mat-form-field appearance="fill" fxFlex="18">
        <mat-label>Numero de Afiliado</mat-label>
        <input type="text" matInput formControlName="numeroAfiliado"
          [disabled]="!this.patientForm.get('patient.os.nombre')" inputmode="numeric" pattern="[0-9]*">
        <mat-error *ngIf="patientForm.get('patient')?.get('os')?.get('numeroAfiliado')?.errors?.required">
          Debe ingresar el número de afiliado.
        </mat-error>
        <mat-error *ngIf="patientForm.get('patient')?.get('os')?.get('numeroAfiliado')?.errors?.pattern">
          Sólo
          se permiten
          números.
        </mat-error>
      </mat-form-field>
    </div>
  </div>
</div>